// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  MASTER_ADMIN   // Acceso total al sistema
  SUPPORT_ADMIN  // Apoyo administrativo, aprobaciones
  MERCHANT       // Comerciante, escanea QR y cobra puntos
  USER           // Usuario ciudadano
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum TransactionType {
  EARNED   // Ganancia de puntos
  SPENT    // Gasto de puntos
  REFUND   // Devolución de puntos
}

enum SubmissionStatus {
  PENDING   // Esperando aprobación
  APPROVED  // Aprobada y puntos acreditados
  REJECTED  // Rechazada
}

enum FrequencyType {
  ONCE            // Única vez en toda la historia
  DAILY           // Se puede completar una vez al día
  WEEKLY          // Se puede completar una vez a la semana
  MONTHLY         // Se puede completar una vez al mes
  QUARTERLY       // Se puede completar una vez cada trimestre (3 meses)
  YEARLY          // Se puede completar una vez al año
  ELECTION_PERIOD // Válida solo durante periodos electorales
}

// ============================================
// MODELS
// ============================================

/// Usuarios del sistema (ciudadanos, comerciantes y administradores)
model User {
  id                String           @id @default(uuid())
  name              String           @db.VarChar(255)
  email             String           @unique @db.VarChar(255)
  passwordHash      String           @map("password_hash") @db.VarChar(255)
  role              UserRole         @default(USER)
  status            UserStatus       @default(ACTIVE)
  mustChangePassword Boolean         @default(false)
  
  // Timestamps
  registeredAt      DateTime         @default(now()) @map("fecha_registro") @db.Timestamptz(3)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  wallet            Wallet?          // Billetera: relación 1:1
  merchantProfile   MerchantProfile? // Perfil de comerciante (si es comerciante)
  missionSubmissions MissionSubmission[] // Misiones enviadas por el usuario
  validatedSubmissions MissionSubmission[] @relation("AdminValidations") // Aprobaciones hechas por este admin
  adminLogs         AdminLog[]       // Decisiones administrativas que ha tomado
  benefitsOwned     Benefit[]        // Beneficios que posee como comerciante
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

/// Billetera de puntos del usuario (relación 1:1 con User)
model Wallet {
  id           String               @id @default(uuid())
  userId       String               @unique @map("user_id")
  balance      Int                  @default(0)
  version      Int                  @default(0) // Optimistic Concurrency Control
  
  // Timestamps
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt    DateTime             @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions PointTransaction[]   // Historial de transacciones
  
  @@index([userId])
  @@map("wallets")
}

/// Historial de transacciones de puntos (inmutable)
model PointTransaction {
  id           String          @id @default(uuid())
  walletId     String          @map("wallet_id")
  type         TransactionType
  amount       Int             // Cantidad de puntos (siempre positivo)
  description  String          @db.Text
  benefitId    String?         @map("benefit_id") // Referencia al beneficio canjeado (opcional)
  
  // Metadata adicional
  metadata     Json?           // Campo flexible para datos adicionales
  
  // Timestamps
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(3)
  
  // Relaciones
  wallet       Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  benefit      Benefit?        @relation(fields: [benefitId], references: [id], onDelete: SetNull)
  
  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@index([benefitId])
  @@map("point_transactions")
}

/// Catálogo de beneficios canjeables (Normalización 3NF: pertenece a un comercio)
model Benefit {
  id               String             @id @default(uuid())
  merchantId       String             @map("merchant_id")
  title            String             @db.VarChar(255)
  description      String?            @db.Text
  pointsCost       Int
  stock            Int                @default(0)
  imageUrl         String?            @db.VarChar(500)
  active           Boolean            @default(true)
  category         String?            @db.VarChar(100)
  cooldownDays     Int                @default(0) @map("cooldown_days")
  version          Int                @default(0)
  
  // Timestamps
  createdAt        DateTime           @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt        DateTime           @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  merchant         User               @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  transactions     PointTransaction[]
  
  @@index([merchantId])
  @@index([active])
  @@index([pointsCost])
  @@map("benefits")
}

/// Perfil de Comerciante (Normalización 3NF)
model MerchantProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  storeName     String   @db.VarChar(255)
  address       String?  @db.VarChar(500)
  phone         String?  @db.VarChar(20)
  rut           String?  @unique @db.VarChar(20)
  
  // Timestamps
  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)
  
  // Relaciones
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("merchant_profiles")
}

/// Catálogo Dinámico de Misiones (gestionable por administrador)
model Mission {
  id            String         @id @default(uuid())
  name          String         @unique @db.VarChar(255)
  description   String?        @db.Text
  points        Int
  frequency     FrequencyType
  cooldownDays  Int            @default(0)
  evidenceType  String         @db.VarChar(50)
  active        Boolean        @default(true)
  
  // Timestamps
  createdAt     DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(3)
  
  // Relaciones
  submissions   MissionSubmission[]
  
  @@index([active])
  @@index([frequency])
  @@map("missions")
}

/// Bandeja de Aprobaciones y Evidencias (separación de definición vs ejecución - 3NF)
model MissionSubmission {
  id             String           @id @default(uuid())
  userId         String
  missionId      String
  evidenceUrl    String           @db.VarChar(500)
  status         SubmissionStatus @default(PENDING)
  observation    String?          @db.Text
  validatedById  String?
  
  // Timestamps
  createdAt      DateTime         @default(now()) @db.Timestamptz(3)
  validatedAt    DateTime?
  
  // Relaciones
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission        Mission          @relation(fields: [missionId], references: [id], onDelete: Cascade)
  validatedBy    User?            @relation("AdminValidations", fields: [validatedById], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([missionId])
  @@index([status])
  @@index([validatedById])
  @@map("mission_submissions")
}

/// Auditoría y Transparencia: Historial de decisiones administrativas
model AdminLog {
  id          String   @id @default(uuid())
  adminId     String
  action      String   @db.VarChar(255)
  targetId    String   @db.VarChar(255)
  metadata    Json?
  description String?  @db.Text
  
  // Timestamps
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  
  // Relaciones
  admin       User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("admin_logs")
}
