// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  MASTER_ADMIN   // Acceso total al sistema
  SUPPORT_ADMIN  // Apoyo administrativo, aprobaciones
  MERCHANT       // Comerciante, escanea QR y cobra puntos
  USER           // Usuario ciudadano
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum TransactionType {
  EARNED   // Ganancia de puntos
  SPENT    // Gasto de puntos
  REFUND   // Devolución de puntos
}

enum SubmissionStatus {
  PENDING   // Esperando aprobación
  APPROVED  // Aprobada y puntos acreditados
  REJECTED  // Rechazada
}

enum FrequencyType {
  ONCE            // Única vez en toda la historia
  DAILY           // Se puede completar una vez al día
  WEEKLY          // Se puede completar una vez a la semana
  MONTHLY         // Se puede completar una vez al mes
  QUARTERLY       // Se puede completar una vez cada trimestre (3 meses)
  YEARLY          // Se puede completar una vez al año
  ELECTION_PERIOD // Válida solo durante periodos electorales
}

enum RedemptionStatus {
  PENDING   // QR generado, esperando ser escaneado
  REDEEMED  // Ya fue escaneado y validado por el comerciante
  EXPIRED   // Pasó el tiempo límite de validez
  CANCELLED // Usuario canceló el canje
}

enum EvidenceType {
  PHOTO       // Fotografía como evidencia
  DOCUMENT    // Documento oficial
  CERTIFICATE // Certificado
  RECEIPT     // Recibo o comprobante
}

// ============================================
// MODELS
// ============================================

/// Usuarios del sistema (ciudadanos, comerciantes y administradores)
model User {
  id                String           @id @default(uuid())
  name              String           @db.VarChar(255)
  email             String           @unique @db.VarChar(255)
  passwordHash      String           @map("password_hash") @db.VarChar(255)
  role              UserRole         @default(USER)
  status            UserStatus       @default(ACTIVE)
  emailVerified     Boolean          @default(false) @map("email_verified")
  mustChangePassword Boolean         @default(false) @map("mustChangePassword")
  lastLoginAt       DateTime?        @map("last_login_at") @db.Timestamptz(3)
  
  // Timestamps
  registeredAt      DateTime         @default(now()) @map("fecha_registro") @db.Timestamptz(3)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  wallet            Wallet?          // Billetera: relación 1:1
  merchantProfile   MerchantProfile? // Perfil de comerciante (si es comerciante)
  missionSubmissions MissionSubmission[] // Misiones enviadas por el usuario
  missionCompletions MissionCompletion[] // Registro de misiones completadas
  validatedSubmissions MissionSubmission[] @relation("AdminValidations") // Aprobaciones hechas por este admin
  adminLogs         AdminLog[]       // Decisiones administrativas que ha tomado
  benefitsOwned     Benefit[]        // Beneficios que posee como comerciante
  redemptions       BenefitRedemption[] // Beneficios que ha canjeado
  merchantScans     BenefitRedemption[] @relation("MerchantScans") // Canjes que este comerciante escaneó
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

/// Billetera de puntos del usuario (relación 1:1 con User)
model Wallet {
  id           String               @id @default(uuid())
  userId       String               @unique @map("user_id")
  balance      Int                  @default(0)
  version      Int                  @default(0) // Optimistic Concurrency Control
  
  // Timestamps
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt    DateTime             @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions PointTransaction[]   // Historial de transacciones
  
  @@index([userId])
  @@map("wallets")
  // CONSTRAINT DE SEGURIDAD: Prevenir saldo negativo
  // PostgreSQL no soporta CHECK constraints nativamente en Prisma
  // Se debe crear manualmente con una migración
}

/// Historial de transacciones de puntos (inmutable)
model PointTransaction {
  id           String          @id @default(uuid())
  walletId     String          @map("wallet_id")
  type         TransactionType
  amount       Int             // Cantidad de puntos (siempre positivo)
  description  String          @db.Text
  benefitId    String?         @map("benefit_id") // Referencia al beneficio canjeado (opcional)
  
  // Metadata adicional
  metadata     Json?           // Campo flexible para datos adicionales
  
  // Timestamps
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(3)
  
  // Relaciones
  wallet       Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  benefit      Benefit?        @relation(fields: [benefitId], references: [id], onDelete: SetNull)
  
  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@index([benefitId])
  @@map("point_transactions")
}

/// Catálogo de beneficios canjeables (Normalización 3NF: pertenece a un comercio)
model Benefit {
  id               String             @id @default(uuid())
  merchantId       String             @map("merchant_id")
  title            String             @db.VarChar(255)
  description      String?            @db.Text
  pointsCost       Int                @map("pointsCost")
  stock            Int                @default(0)
  reservedStock    Int                @default(0) @map("reserved_stock")
  imageUrl         String?            @db.VarChar(500) @map("imageUrl")
  active           Boolean            @default(true)
  category         String?            @db.VarChar(100)
  cooldownDays     Int                @default(0) @map("cooldown_days")
  version          Int                @default(0)
  
  // Timestamps
  createdAt        DateTime           @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt        DateTime           @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  merchant         User               @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  transactions     PointTransaction[]
  redemptions      BenefitRedemption[]
  
  @@index([merchantId])
  @@index([active])
  @@index([pointsCost])
  @@map("benefits")
}

/// Perfil de Comerciante (Normalización 3NF)
model MerchantProfile {
  id            String   @id @default(uuid())
  userId        String   @unique @map("userId")
  storeName     String   @db.VarChar(255) @map("storeName")
  address       String?  @db.VarChar(500)
  phone         String?  @db.VarChar(20)
  rut           String?  @unique @db.VarChar(20)
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("createdAt") @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @map("updatedAt") @db.Timestamptz(3)
  
  // Relaciones
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("merchant_profiles")
}

/// Catálogo Dinámico de Misiones (gestionable por administrador)
model Mission {
  id            String         @id @default(uuid())
  name          String         @unique @db.VarChar(255)
  description   String?        @db.Text
  points        Int
  frequency     FrequencyType
  cooldownDays  Int            @default(0) @map("cooldownDays")
  evidenceType  EvidenceType   @default(PHOTO) @map("evidenceType")
  active        Boolean        @default(true)
  expiresAt     DateTime?      @map("expiresAt") @db.Timestamptz(3)
  
  // Timestamps
  createdAt     DateTime       @default(now()) @map("createdAt") @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  // Relaciones
  submissions   MissionSubmission[]
  completions   MissionCompletion[]
  
  @@index([active])
  @@index([frequency])
  @@index([expiresAt])
  @@map("missions")
}

/// Bandeja de Aprobaciones y Evidencias (separación de definición vs ejecución - 3NF)
model MissionSubmission {
  id             String           @id @default(uuid())
  userId         String           @map("userId")
  missionId      String           @map("missionId")
  evidenceUrl    String           @db.VarChar(500)
  status         SubmissionStatus @default(PENDING)
  observation    String?          @db.Text
  validatedById  String?          @map("validatedById")
  
  // Timestamps
  createdAt      DateTime         @default(now()) @db.Timestamptz(3)
  validatedAt    DateTime?
  
  // Relaciones
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission        Mission          @relation(fields: [missionId], references: [id], onDelete: Cascade)
  validatedBy    User?            @relation("AdminValidations", fields: [validatedById], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([missionId])
  @@index([status])
  @@index([validatedById])
  @@map("mission_submissions")
}

/// Auditoría y Transparencia: Historial de decisiones administrativas
model AdminLog {
  id          String   @id @default(uuid())
  adminId     String   @map("adminId")
  action      String   @db.VarChar(255)
  targetId    String   @db.VarChar(255) @map("targetId")
  metadata    Json?
  description String?  @db.Text
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("createdAt") @db.Timestamptz(3)
  
  // Relaciones
  admin       User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("admin_logs")
}

/// Registro de misiones completadas por usuario (para validar frecuencia)
model MissionCompletion {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  missionId     String   @map("mission_id")
  
  // Timestamps
  completedAt   DateTime @default(now()) @map("completed_at") @db.Timestamptz(3)
  
  // Relaciones
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission       Mission  @relation(fields: [missionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, missionId, completedAt])
  @@index([userId])
  @@index([missionId])
  @@index([completedAt])
  @@map("mission_completions")
}

/// Canjes de beneficios (QR generado para el usuario, validado por el comerciante)
model BenefitRedemption {
  id             String             @id @default(uuid())
  userId         String             @map("user_id")
  benefitId      String             @map("benefit_id")
  qrCode         String             @unique @db.VarChar(255) @map("qr_code") // Código único para escanear
  status         RedemptionStatus   @default(PENDING)
  
  // Validación por comerciante
  scannedByMerchantId String?        @map("scanned_by_merchant_id") // Qué comerciante lo escaneó
  scannedAt      DateTime?          @map("scanned_at") @db.Timestamptz(3)
  
  // Expiración
  expiresAt      DateTime           @map("expires_at") @db.Timestamptz(3)
  
  // Timestamps
  createdAt      DateTime           @default(now()) @map("created_at") @db.Timestamptz(3)
  redeemedAt     DateTime?          @map("redeemed_at") @db.Timestamptz(3)
  
  // Relaciones
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  benefit        Benefit            @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  scannedByMerchant User?           @relation("MerchantScans", fields: [scannedByMerchantId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([benefitId])
  @@index([status])
  @@index([expiresAt])
  @@index([scannedByMerchantId])
  @@map("benefit_redemptions")
}
